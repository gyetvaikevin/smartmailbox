{
  "Description": "Root Stack for AWS Amplify CLI",
  "AWSTemplateFormatVersion": "2010-09-09",
  "Parameters": {
    "DeploymentBucketName": {
      "Type": "String",
      "Default": "DeploymentBucket",
      "Description": "Name of the common deployment bucket provided by the parent stack"
    },
    "AuthRoleName": {
      "Type": "String",
      "Default": "AuthRoleName",
      "Description": "Name of the common deployment bucket provided by the parent stack"
    },
    "UnauthRoleName": {
      "Type": "String",
      "Default": "UnAuthRoleName",
      "Description": "Name of the common deployment bucket provided by the parent stack"
    }
  },
  "Outputs": {
    "Region": {
      "Description": "CloudFormation provider root stack Region",
      "Value": {
        "Ref": "AWS::Region"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-Region"
        }
      }
    },
    "StackName": {
      "Description": "CloudFormation provider root stack ID",
      "Value": {
        "Ref": "AWS::StackName"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-StackName"
        }
      }
    },
    "StackId": {
      "Description": "CloudFormation provider root stack name",
      "Value": {
        "Ref": "AWS::StackId"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-StackId"
        }
      }
    },
    "AuthRoleArn": {
      "Value": {
        "Fn::GetAtt": [
          "AuthRole",
          "Arn"
        ]
      }
    },
    "UnauthRoleArn": {
      "Value": {
        "Fn::GetAtt": [
          "UnauthRole",
          "Arn"
        ]
      }
    },
    "DeploymentBucketName": {
      "Description": "CloudFormation provider root stack deployment bucket name",
      "Value": {
        "Ref": "DeploymentBucketName"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-DeploymentBucketName"
        }
      }
    },
    "AuthRoleName": {
      "Value": {
        "Ref": "AuthRole"
      }
    },
    "UnauthRoleName": {
      "Value": {
        "Ref": "UnauthRole"
      }
    }
  },
  "Resources": {
    "DeploymentBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": {
          "Ref": "DeploymentBucketName"
        },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256"
              }
            }
          ]
        }
      },
      "UpdateReplacePolicy": "Retain",
      "DeletionPolicy": "Retain"
    },
    "DeploymentBucketBlockHTTP": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": {
          "Ref": "DeploymentBucketName"
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:*",
              "Effect": "Deny",
              "Principal": "*",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "DeploymentBucketName"
                      },
                      "/*"
                    ]
                  ]
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "DeploymentBucketName"
                      }
                    ]
                  ]
                }
              ],
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": false
                }
              }
            }
          ]
        }
      }
    },
    "AuthRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "",
              "Effect": "Deny",
              "Principal": {
                "Federated": "cognito-identity.amazonaws.com"
              },
              "Action": "sts:AssumeRoleWithWebIdentity"
            }
          ]
        },
        "RoleName": {
          "Ref": "AuthRoleName"
        }
      }
    },
    "UnauthRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "",
              "Effect": "Deny",
              "Principal": {
                "Federated": "cognito-identity.amazonaws.com"
              },
              "Action": "sts:AssumeRoleWithWebIdentity"
            }
          ]
        },
        "RoleName": {
          "Ref": "UnauthRoleName"
        }
      }
    },
    "APIGatewayAuthStack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://s3.amazonaws.com/amplify-mailboxapp-dev-56efe-deployment/amplify-cfn-templates/api/APIGatewayAuthStack.json",
        "Parameters": {
          "authRoleName": {
            "Ref": "AuthRoleName"
          },
          "unauthRoleName": {
            "Ref": "UnauthRoleName"
          },
          "env": "dev",
          "SmartMailboxAPIv2": {
            "Fn::GetAtt": [
              "apiSmartMailboxAPIv2",
              "Outputs.ApiId"
            ]
          }
        }
      }
    },
    "apiSmartMailboxAPIv2": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://s3.amazonaws.com/amplify-mailboxapp-dev-56efe-deployment/amplify-cfn-templates/api/SmartMailboxAPIv2-cloudformation-template.json",
        "Parameters": {
          "functionlistDevicesName": {
            "Fn::GetAtt": [
              "functionlistDevices",
              "Outputs.Name"
            ]
          },
          "functionlistDevicesArn": {
            "Fn::GetAtt": [
              "functionlistDevices",
              "Outputs.Arn"
            ]
          },
          "functionlinkDeviceName": {
            "Fn::GetAtt": [
              "functionlinkDevice",
              "Outputs.Name"
            ]
          },
          "functionlinkDeviceArn": {
            "Fn::GetAtt": [
              "functionlinkDevice",
              "Outputs.Arn"
            ]
          },
          "functiongetLatestStatusName": {
            "Fn::GetAtt": [
              "functiongetLatestStatus",
              "Outputs.Name"
            ]
          },
          "functiongetLatestStatusArn": {
            "Fn::GetAtt": [
              "functiongetLatestStatus",
              "Outputs.Arn"
            ]
          },
          "functionmanualOpenName": {
            "Fn::GetAtt": [
              "functionmanualOpen",
              "Outputs.Name"
            ]
          },
          "functionmanualOpenArn": {
            "Fn::GetAtt": [
              "functionmanualOpen",
              "Outputs.Arn"
            ]
          },
          "functionupdateStatusName": {
            "Fn::GetAtt": [
              "functionupdateStatus",
              "Outputs.Name"
            ]
          },
          "functionupdateStatusArn": {
            "Fn::GetAtt": [
              "functionupdateStatus",
              "Outputs.Arn"
            ]
          },
          "functiongetDeviceLogsName": {
            "Fn::GetAtt": [
              "functiongetDeviceLogs",
              "Outputs.Name"
            ]
          },
          "functiongetDeviceLogsArn": {
            "Fn::GetAtt": [
              "functiongetDeviceLogs",
              "Outputs.Arn"
            ]
          },
          "functionunlockDeviceName": {
            "Fn::GetAtt": [
              "functionunlockDevice",
              "Outputs.Name"
            ]
          },
          "functionunlockDeviceArn": {
            "Fn::GetAtt": [
              "functionunlockDevice",
              "Outputs.Arn"
            ]
          },
          "functionsetPasswordName": {
            "Fn::GetAtt": [
              "functionsetPassword",
              "Outputs.Name"
            ]
          },
          "functionsetPasswordArn": {
            "Fn::GetAtt": [
              "functionsetPassword",
              "Outputs.Arn"
            ]
          },
          "env": "dev"
        }
      }
    },
    "functiongetLatestStatus": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://s3.amazonaws.com/amplify-mailboxapp-dev-56efe-deployment/amplify-cfn-templates/function/getLatestStatus-cloudformation-template.json",
        "Parameters": {
          "deploymentBucketName": "amplify-mailboxapp-dev-56efe-deployment",
          "s3Key": "amplify-builds/getLatestStatus-595a615878755765427a-build.zip",
          "tableName": "SmartMailboxStorage-dev",
          "storageSmartMailboxStorageName": {
            "Fn::GetAtt": [
              "storageSmartMailboxStorage",
              "Outputs.Name"
            ]
          },
          "storageSmartMailboxStorageArn": {
            "Fn::GetAtt": [
              "storageSmartMailboxStorage",
              "Outputs.Arn"
            ]
          },
          "env": "dev"
        }
      }
    },
    "functionupdateStatus": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://s3.amazonaws.com/amplify-mailboxapp-dev-56efe-deployment/amplify-cfn-templates/function/updateStatus-cloudformation-template.json",
        "Parameters": {
          "deploymentBucketName": "amplify-mailboxapp-dev-56efe-deployment",
          "s3Key": "amplify-builds/updateStatus-6339337343683576746a-build.zip",
          "env": "dev"
        }
      }
    },
    "functionmanualOpen": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://s3.amazonaws.com/amplify-mailboxapp-dev-56efe-deployment/amplify-cfn-templates/function/manualOpen-cloudformation-template.json",
        "Parameters": {
          "iotEndpoint": "aw0jttguq1qsu-ats.iot.eu-central-1.amazonaws.com",
          "deploymentBucketName": "amplify-mailboxapp-dev-56efe-deployment",
          "s3Key": "amplify-builds/manualOpen-43354130317250526351-build.zip",
          "env": "dev"
        }
      }
    },
    "functionprocessDeviceEvents": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://s3.amazonaws.com/amplify-mailboxapp-dev-56efe-deployment/amplify-cfn-templates/function/processDeviceEvents-cloudformation-template.json",
        "Parameters": {
          "deploymentBucketName": "amplify-mailboxapp-dev-56efe-deployment",
          "s3Key": "amplify-builds/processDeviceEvents-437a417676566a753666-build.zip",
          "env": "dev"
        }
      }
    },
    "functionlistDevices": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://s3.amazonaws.com/amplify-mailboxapp-dev-56efe-deployment/amplify-cfn-templates/function/listDevices-cloudformation-template.json",
        "Parameters": {
          "deploymentBucketName": "amplify-mailboxapp-dev-56efe-deployment",
          "s3Key": "amplify-builds/listDevices-367858346367716d4a59-build.zip",
          "storageuserdevicesName": {
            "Fn::GetAtt": [
              "storageuserdevices",
              "Outputs.Name"
            ]
          },
          "storageuserdevicesArn": {
            "Fn::GetAtt": [
              "storageuserdevices",
              "Outputs.Arn"
            ]
          },
          "storageuserdevicesStreamArn": {
            "Fn::GetAtt": [
              "storageuserdevices",
              "Outputs.StreamArn"
            ]
          },
          "env": "dev"
        }
      }
    },
    "functionlinkDevice": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://s3.amazonaws.com/amplify-mailboxapp-dev-56efe-deployment/amplify-cfn-templates/function/linkDevice-cloudformation-template.json",
        "Parameters": {
          "deploymentBucketName": "amplify-mailboxapp-dev-56efe-deployment",
          "s3Key": "amplify-builds/linkDevice-3437792f6c4333717055-build.zip",
          "storageuserdevicesName": {
            "Fn::GetAtt": [
              "storageuserdevices",
              "Outputs.Name"
            ]
          },
          "storageuserdevicesArn": {
            "Fn::GetAtt": [
              "storageuserdevices",
              "Outputs.Arn"
            ]
          },
          "storageuserdevicesStreamArn": {
            "Fn::GetAtt": [
              "storageuserdevices",
              "Outputs.StreamArn"
            ]
          },
          "env": "dev"
        }
      }
    },
    "functionPreSignupClean": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://s3.amazonaws.com/amplify-mailboxapp-dev-56efe-deployment/amplify-cfn-templates/function/PreSignupClean-cloudformation-template.json",
        "Parameters": {
          "deploymentBucketName": "amplify-mailboxapp-dev-56efe-deployment",
          "s3Key": "amplify-builds/PreSignupClean-6f55335046635345715a-build.zip",
          "env": "dev"
        }
      }
    },
    "functionPostConfirmationClean": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://s3.amazonaws.com/amplify-mailboxapp-dev-56efe-deployment/amplify-cfn-templates/function/PostConfirmationClean-cloudformation-template.json",
        "Parameters": {
          "deploymentBucketName": "amplify-mailboxapp-dev-56efe-deployment",
          "s3Key": "amplify-builds/PostConfirmationClean-79523138776d54447750-build.zip",
          "env": "dev"
        }
      }
    },
    "functiongetDeviceLogs": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://s3.amazonaws.com/amplify-mailboxapp-dev-56efe-deployment/amplify-cfn-templates/function/getDeviceLogs-cloudformation-template.json",
        "Parameters": {
          "deploymentBucketName": "amplify-mailboxapp-dev-56efe-deployment",
          "s3Key": "amplify-builds/getDeviceLogs-687468414b636a6b5469-build.zip",
          "storageMailboxQRLogsName": {
            "Fn::GetAtt": [
              "storageMailboxQRLogs",
              "Outputs.Name"
            ]
          },
          "storageMailboxQRLogsArn": {
            "Fn::GetAtt": [
              "storageMailboxQRLogs",
              "Outputs.Arn"
            ]
          },
          "storageMailboxQRLogsStreamArn": {
            "Fn::GetAtt": [
              "storageMailboxQRLogs",
              "Outputs.StreamArn"
            ]
          },
          "env": "dev"
        }
      }
    },
    "functionunlockDevice": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://s3.amazonaws.com/amplify-mailboxapp-dev-56efe-deployment/amplify-cfn-templates/function/unlockDevice-cloudformation-template.json",
        "Parameters": {
          "deploymentBucketName": "amplify-mailboxapp-dev-56efe-deployment",
          "s3Key": "amplify-builds/unlockDevice-68565032366968637553-build.zip",
          "env": "dev"
        }
      }
    },
    "functionsetPassword": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://s3.amazonaws.com/amplify-mailboxapp-dev-56efe-deployment/amplify-cfn-templates/function/setPassword-cloudformation-template.json",
        "Parameters": {
          "deploymentBucketName": "amplify-mailboxapp-dev-56efe-deployment",
          "s3Key": "amplify-builds/setPassword-2b6f756d39504b6d2b46-build.zip",
          "env": "dev"
        }
      }
    },
    "storageSmartMailboxStorage": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://s3.amazonaws.com/amplify-mailboxapp-dev-56efe-deployment/amplify-cfn-templates/storage/SmartMailboxStorage-cloudformation-template.json",
        "Parameters": {
          "tableName": "SmartMailboxStorage",
          "partitionKeyName": "deviceId",
          "partitionKeyType": "S",
          "env": "dev"
        }
      }
    },
    "storageMailboxQRLogs": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://s3.amazonaws.com/amplify-mailboxapp-dev-56efe-deployment/amplify-cfn-templates/storage/MailboxQRLogs-cloudformation-template.json",
        "Parameters": {
          "tableName": "MailboxQRLogs",
          "partitionKeyName": "deviceId",
          "partitionKeyType": "S",
          "sortKeyName": "timestamp",
          "sortKeyType": "S",
          "env": "dev"
        }
      }
    },
    "storageuserdevices": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://s3.amazonaws.com/amplify-mailboxapp-dev-56efe-deployment/amplify-cfn-templates/storage/userdevices-cloudformation-template.json",
        "Parameters": {
          "tableName": "UserDevices",
          "partitionKeyName": "userId",
          "partitionKeyType": "S",
          "sortKeyName": "deviceId",
          "sortKeyType": "S",
          "env": "dev"
        }
      }
    }
  }
}