üìÑ SmartMailbox Teljes Kommunik√°ci√≥s Dokument√°ci√≥
(Friss√≠tve: 2025. okt√≥ber v√©ge ut√°n ‚Äì audit log frontend integr√°ci√≥ + reszponz√≠v UI overhaul)

Komponensek: ESP32 firmware + Backend (AWS IoT Core + Lambda + DynamoDB) + User‚ÄìDevice Linking + Frontend (React) + Cognito Auth

1. ESP32 kommunik√°ci√≥
(v√°ltozatlan)

Heartbeat (.../status ‚Üí "online")

Esem√©ny logok (lock √°llapot, trigger, QR)

Ack √ºzenetek (.../ack)

Parancs fogad√°s (.../cmd)

Be√©p√≠tett webszerver (diagnosztika: /lock1, /lock2, /mqttconnect, /ip)

QR modul UART‚Äëon

Lock √°llapotfigyel√©s

2. Backend kommunik√°ci√≥
üì§ ESP32 ‚Üí Backend
updateStatus-dev ‚Üí SmartMailboxStorage-dev Friss√≠ti az aktu√°lis z√°r√°llapotot (lock1, lock2 ‚Üí BOOL)

processDeviceEvents-dev ‚Üí MailboxQRLogs-dev Ment audit esem√©nyt:

trigger:

code ‚Üí QR/vonalk√≥d

web ‚Üí t√°voli parancs (MQTT)

manual ‚Üí touch UI

unknown ‚Üí nem azonos√≠that√≥

state: mindig "CLOSED" (csak csuk√≥d√°s ker√ºl napl√≥z√°sra)

qr: opcion√°lis, csak k√≥dos nyit√°sn√°l

(Az automatikus t√∂rl√©s logika kiker√ºlt, minden esem√©ny megmarad az audit t√°bl√°ban.)

üì• Backend ‚Üí ESP32
manualOpen-dev ‚Üí MQTT publish ‚Üí postalada/<THINGNAME>/cmd Payload: { "cmd":"open_lock1" } vagy { "cmd":"open_lock2" }

3. Frontend ‚Üí Backend
‚úÖ Valid√°lt m≈±k√∂d√©s
Webes z√°rvez√©rl√©s: m≈±k√∂dik, a felhaszn√°l√≥ a UI‚Äëb√≥l nyit/z√°r ‚Üí parancs MQTT‚Äën √°tjut az ESP32‚Äëre

√Ållapotkezel√©s: m≈±k√∂dik, /statusget v√©gpont ‚Üí "OPEN" / "CLOSED" st√°tusz, sz√≠nk√≥dolt UI (z√∂ld/piros)

Audit logok: m≈±k√∂dik, /logs v√©gpont ‚Üí t√°bl√°zatos megjelen√≠t√©s a LogsTable komponensben

V√©gpontok
/statusget (POST) ‚Üí getLatestStatus-dev ‚Üí SmartMailboxStorage-dev

/manual (POST) ‚Üí manualOpen-dev ‚Üí IoT Core ‚Üí ESP32

/listDevices (GET) ‚Üí listDevices-dev ‚Üí userdevices

/linkDevice (POST) ‚Üí linkDevice-dev ‚Üí userdevices

√öJ: /logs (GET) ‚Üí getDeviceLogs-dev ‚Üí MailboxQRLogs-dev

4. DynamoDB t√°bl√°k
T√°bla	Kulcs	Mez≈ëk	Szerep
SmartMailboxStorage-dev	deviceId	lock1, lock2 (BOOL), lastUpdated (ISO)	Aktu√°lis √°llapot
MailboxQRLogs-dev	deviceId + timestamp	lock, state, trigger, qr, timestamp	Audit trail (minden esem√©ny)
userdevices	userId + deviceId	‚Äì	Felhaszn√°l√≥‚Äìeszk√∂z kapcsolatok
5. Kommunik√°ci√≥s √∂sszefoglal√≥ t√°bl√°zat
Forr√°s	C√©l	Protokoll	T√©ma/Endpoint	Payload p√©lda	Megjegyz√©s
ESP32	IoT Core	MQTT	.../status	"online"	Heartbeat
ESP32	IoT Core	MQTT	.../status	{ "device":"SmartMailbox1","lock":"lock1","state":"CLOSED","trigger":"code","qr":"5056784907320" }	Esem√©ny log
ESP32	IoT Core	MQTT	.../ack	{ "result":"lock1_opened" }	Ack
Backend	ESP32	MQTT	.../cmd	{ "cmd":"open_lock1" }	Parancs
Frontend	API GW	HTTPS	/statusget	{ "deviceId":"SmartMailbox1" }	St√°tusz lek√©r√©s
API GW	Frontend	HTTPS	/statusget	{ "deviceId":"SmartMailbox1","status":{"lock1":"OPEN","lock2":"CLOSED"} }	V√°lasz
Frontend	API GW	HTTPS	/manual	{ "deviceId":"SmartMailbox1","lock":"lock1","action":"open" }	K√©zi vez√©rl√©s
API GW	Frontend	HTTPS	/manual	{ "deviceId":"SmartMailbox1","lock":"lock1","action":"open","result":"success" }	V√°lasz
Frontend	API GW	HTTPS	/listDevices	‚Äì	User eszk√∂zlista
API GW	Frontend	HTTPS	/linkDevice	{ "deviceId":"SmartMailbox1" }	User‚Äìdevice kapcsolat
Frontend	API GW	HTTPS	/logs	?deviceId=SmartMailbox1	Audit log lek√©r√©s
API GW	Frontend	HTTPS	/logs	[{"timestamp":"...","lock":"lock1","state":"CLOSED","trigger":"code","qr":"5056784907320"}, {...}]	Audit log v√°lasz
User	ESP32	HTTP GET	/lock1	‚Äì	Lock1 nyit√°sa
User	ESP32	HTTP GET	/lock2	‚Äì	Lock2 nyit√°sa
User	ESP32	HTTP GET	/mqttconnect	‚Äì	MQTT reconnect
User	ESP32	HTTP GET	/ip	‚Äì	IP c√≠m lek√©r√©s
QR modul	ESP32	UART	"XYZ123\n"	QR/vonalk√≥d string
6. Folyamat√°bra (sz√∂vegesen, b≈ëv√≠tve)
Felhaszn√°l√≥ / Fut√°r ‚Üí (QR k√≥d, vonalk√≥d, gombnyom√°s, web UI, frontend) ‚ñº ESP32 firmware

MQTT publish ‚Üí IoT Core ‚Üí Lambda (updateStatus-dev) ‚Üí SmartMailboxStorage-dev

MQTT publish ‚Üí IoT Core ‚Üí Lambda (processDeviceEvents-dev) ‚Üí MailboxQRLogs-dev

MQTT publish ‚Üí IoT Core ‚Üí topicAck

MQTT subscribe ‚Üê IoT Core ‚Üê Lambda (manualOpen-dev) ‚Üê API GW (/manual)

Frontend / Webapp

HTTPS POST + IdToken /statusget ‚Üí API GW ‚Üí getLatestStatus-dev ‚Üí SmartMailboxStorage-dev

HTTPS POST + IdToken /manual ‚Üí API GW ‚Üí manualOpen-dev ‚Üí IoT Core ‚Üí ESP32

HTTPS GET + IdToken /listDevices ‚Üí API GW ‚Üí listDevices-dev ‚Üí userdevices

HTTPS POST + IdToken /linkDevice ‚Üí API GW ‚Üí linkDevice-dev ‚Üí userdevices

√öJ: HTTPS GET + IdToken /logs?deviceId=... ‚Üí API GW ‚Üí getDeviceLogs-dev ‚Üí MailboxQRLogs-dev

7. Hiteles√≠t√©s √©s regisztr√°ci√≥s logika
(v√°ltozatlan)

Cognito User Pool + PreSignUpClean Lambda

Google IdP integr√°ci√≥

Duplik√°lt regisztr√°ci√≥ tilt√°s

GDPR‚Äëkompatibilis m≈±k√∂d√©s

‚úÖ √öjdons√°gok √∂sszefoglalva
/logs v√©gpont ‚Üí audit trail lek√©r√©s

getDeviceLogs-dev Lambda ‚Üí DynamoDB query a MailboxQRLogs-dev t√°bl√°b√≥l

Frontend:

√öj LogsPage + LogsTable komponensek

Audit logok t√°bl√°zatos megjelen√≠t√©se

Reszponz√≠v, teljes sz√©less√©g≈± UI overhaul (navbar, dashboard grid, log t√°bl√°zat)